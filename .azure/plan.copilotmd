# Azure Deployment Plan for codingagentdemo Project

## **Goal**
Deploy a multi-service application to Azure consisting of a Node.js Express backend API and React/Vite frontend using Azure App Services with Infrastructure as Code (Bicep).

## **Project Information**

**CodeDemo Application**  
- **Stack**: Node.js/Express (backend), React/Vite (frontend)  
- **Type**: Full-stack web application with API backend and modern SPA frontend  
- **Containerization**: Docker-ready (can be containerized)  
- **Dependencies**: Express, body-parser, CORS, JWT authentication  
- **Hosting**: Azure App Service (both frontend and backend)  
- **Architecture**: Separate services - frontend calls backend API via HTTP

## **Azure Resources Architecture**

```mermaid
graph TD
svcbackend["`Backend Service
Path: ./backend
Language: Node.js
Port: 3000`"]
svcfrontend["`Frontend Service
Path: ./frontend
Language: React/Vite
Port: 5173`"]

subgraph "Compute Resources"
appservicebackend("`backend<br/>Azure App Service`)
appservicefrontend("`frontend<br/>Azure App Service`)
end

subgraph "Supporting Services"
appinsights["`Application Insights`"]
keyvault["`Key Vault<br/>Config & Secrets`"]
end

svcbackend --> |"hosted on"| appservicebackend
svcfrontend --> |"hosted on"| appservicefrontend
appservicebackend --> |"sends logs to"| appinsights
appservicefrontend --> |"sends logs to"| appinsights
appservicefrontend -.-> |"HTTP API calls"| appservicebackend
appservicebackend -.-> |"reads secrets"| keyvault
appservicefrontend -.-> |"reads config"| keyvault
```

**Service Relationships:**
- The React frontend (App Service) makes HTTP API calls to the Node.js backend (App Service)
- Both services send logs to Application Insights for monitoring
- Backend services access secrets and configuration from Key Vault using Managed Identity

## **Recommended Azure Resources**

### Backend Service
- **Service Name**: backend
- **Hosting Service Type**: Azure App Service (Linux)
- **SKU Recommendation**: B1 (Basic) for development, B2 for production
  - Provides sufficient compute for Node.js API server
  - Scaling capability for increased load
- **Configuration**:
  - **Language**: Node.js (LTS)
  - **Runtime**: Node.js 20.x or 22.x LTS
  - **Environment Variables Required**:
    - `PORT=3000`
    - `NODE_ENV=production`
    - `CORS_ORIGIN=<frontend-app-service-url>`
    - Database connection string (if applicable)

### Frontend Service  
- **Service Name**: frontend
- **Hosting Service Type**: Azure App Service (Linux)
- **SKU Recommendation**: B1 (Basic) for development, B2 for production
  - Suitable for hosting built React static files
- **Configuration**:
  - **Language**: Node.js (for serving static build)
  - **Runtime**: Node.js 20.x or 22.x LTS
  - **Environment Variables Required**:
    - `API_BASE_URL=<backend-app-service-url>`
    - `NODE_ENV=production`

## **Recommended Supporting Services**

1. **Application Insights** (Standard)
   - Integrated monitoring for both App Services
   - Performance metrics, logs, and error tracking
   - Connection string shared across services

2. **Log Analytics Workspace** (Pay-As-You-Go)
   - Centralized logging for all services
   - Application Insights data sink
   - Query and analysis of application logs

3. **Key Vault** (Standard)
   - Secure storage for connection strings and secrets
   - Used by backend for sensitive configuration
   - Accessed via Managed Identity (no exposed credentials)

4. **User-Assigned Managed Identity**
   - Assigned to both App Services
   - Provides secure authentication to Key Vault
   - Eliminates need for hardcoded credentials

## **Recommended Security Configurations**

- **User-Assigned Managed Identity**: 
  - Must have Key Vault Secret User role on Key Vault
  - Must be assigned to both backend and frontend App Services
  
- **Network Security**:
  - Enable HTTPS only
  - Configure CORS properly on backend for frontend communication
  - Consider adding Web Application Firewall (WAF) for production

- **Credential Management**:
  - All connection strings stored in Key Vault
  - No secrets in configuration files or environment
  - Rotation policies for keys and secrets

## **Execution Steps**

### 1. Create Azure Infrastructure Files for AZD

#### Step 1.1: Check Current Files
- Verify if `.azure/` directory exists with `azure.yaml`
- Check if `infra/` directory exists with Bicep files
- Status: Creating new files as none currently exist in the project

#### Step 1.2: Get Available Regions and SKUs
- Call tool to verify region availability for required resource types:
  - `Microsoft.Web/serverfarms` (App Service Plans)
  - `Microsoft.Web/sites` (App Services)
  - `Microsoft.Insights/components` (Application Insights)
  - `Microsoft.KeyVault/vaults` (Key Vault)
- Recommended regions: East US, West Europe, Southeast Asia

#### Step 1.3: Generate IaC Files
Expected files to create:
- `azure.yaml` - AZD project configuration
- `infra/main.bicep` - Main infrastructure definition
- `infra/main.parameters.json` - Parameter values
- Call `appmod-get-iac-rules` for Bicep best practices

### 2. Environment Setup for AZD

#### Step 2.1: Install Prerequisites
- Install Azure CLI (az command)
- Install Azure Developer CLI (azd command)
- Verify PowerShell version (5.1 or later)

#### Step 2.2: Create AZD Environment
- Run: `azd env new`
- This creates a new environment for deployment
- Environment stores configuration and settings

#### Step 2.3: Configure Environment Variables
- `AZURE_SUBSCRIPTION_ID`: Your Azure subscription ID
- `AZURE_RESOURCE_GROUP`: rg-codingagentdemo
- `AZURE_LOCATION`: eastus (or your preferred region)
- `BACKEND_APP_SERVICE_NAME`: codingagentdemo-backend
- `FRONTEND_APP_SERVICE_NAME`: codingagentdemo-frontend

#### Step 2.4: Authenticate with Azure
- Run: `az login` (interactive login)
- Select subscription with: `az account set --subscription <id>`

### 3. Deployment

#### Step 3.1: Validate Infrastructure (Dry Run)
- Run: `azd provision --preview --no-prompt`
- Review generated resources and ARM template
- Validate no errors before actual provisioning

#### Step 3.2: Provision Azure Resources
- Run: `azd provision --no-prompt`
- Creates all Azure resources (App Services, Insights, Key Vault, etc.)
- Applies Bicep templates to your subscription

#### Step 3.3: Deploy Applications
- Run: `azd deploy --no-prompt`
- Deploys backend Node.js API to backend App Service
- Builds and deploys frontend React app to frontend App Service
- Configure environment variables on each App Service

#### Step 3.4: Validation
- Verify backend API is running
- Check frontend is accessible
- Review Application Insights for logs
- Test API communication between frontend and backend

### 4. Summarize Results
- Generate deployment summary with endpoints and resources
- Document cloud URLs and connection details
- Create post-deployment checklist

## **Pre-Deployment Verification Checklist**

- [ ] Azure subscription selected and accessible
- [ ] Sufficient quota for App Service resources in target region
- [ ] .gitignore configured to exclude `.azure/` directory
- [ ] Environment variables documented
- [ ] Backend API listens on PORT environment variable
- [ ] Frontend build process is tested locally
- [ ] CORS is properly configured for frontend-backend communication

## **Post-Deployment Steps**

- [ ] Test backend API endpoints via Postman or curl
- [ ] Access frontend through App Service URL
- [ ] Verify logs in Application Insights
- [ ] Configure custom domain if needed
- [ ] Set up automated backups if using databases
- [ ] Configure firewall rules and access controls

## **Progress Tracking**

- ðŸ”² Step 1.1: Verify existing files
- ðŸ”² Step 1.2: Get available regions and SKUs  
- ðŸ”² Step 1.3: Generate Bicep infrastructure files
- ðŸ”² Step 2: Setup AZD environment
- ðŸ”² Step 3: Deploy applications to Azure
- ðŸ”² Step 4: Summarize and validate deployment

## **Tools to Use**

- [ ] appmod-get-available-region-sku
- [ ] appmod-get-iac-rules
- [ ] mcp_github_copilo_appmod-get-plan (completed)
- [ ] appmod-summarize-result
